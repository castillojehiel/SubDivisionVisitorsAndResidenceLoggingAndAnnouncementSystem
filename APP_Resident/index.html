<!DOCTYPE html>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="fontawesome/css/all.min.css" />
    <link rel="stylesheet" type="text/css" href="css/custom.css" />
    
    <script src="js/jquery_3.6.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.qrcode.min.js"></script>
    <script src="js/printThis.js"></script>

    <style>
        .modal{
            z-index: 100000000000 !important;
            background: rgba(0,0,0,.5);
        }
        #main{
            height: calc(100% - 40px);
            position: fixed;
            top: 0;
            width: 100%;
            overflow: auto;
            padding: 5px 0;
        }
        #navMain .nav-item{
            border-radius: 0px;
        }
        #loginForm{
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: white;
            z-index: 2001;
        }
        #mainCard{
            height: auto;
            top:2vh;
            margin: 100px 0 0 0;
            background : rgba(255,255,255,0.7);
            display:block;
            padding:20px;
            text-align:center;
        }
    </style>

    <div id="loginForm">
        <div id="mainCard" >
            <img src="Images/FiestaHomesLogo.png" style="width:50%; margin:0 auto; display:block"/>
            <h2>Fiesta Homes Gate Pass and Announcement System</h2>
            <hr>
            <form id="frmLogin" style="width:80%; margin:auto" >
                <div class="mb-3">
                    <label for="" style="float:left">Username:</label>
                    <input type="text" class="form-control" name="txtUsername" required value="dev1" >
                </div>
                <div class="mb-3">
                    <label for="" style="float:left">Password:</label>
                    <input type="password" class="form-control" name="txtPassword" required value="dev1" >
                </div>
                <div class="mb-3">
                    <button class="btn btn-primary" style="width: 200px;">
                        <span class="fas fa-login"></span>
                        Login
                    </button>
                </div>
                
            </form>
            
        </div>
        <div class="row">
            <button id="btnChangeConnection" type="button" class="btn btn-link">
                Change Connection
            </button>
        </div>
    </div>

    <div id="main" class="row">

    </div>
    <nav id="navMain" class="nav nav-pills fixed-bottom nav-fill">
        <a id="navItemHome" class="nav-item nav-link active navMainItem" href="#">
            <span class="fas fa-home"></span>
        </a>
        <a id="navItemReports" class="nav-item nav-link navMainItem" href="#">
            <span class="fas fa-flag"></span>
        </a>
        <a id="navItemProfile" class="nav-item nav-link navMainItem" href="#">
            <span class="fas fa-user"></span>
        </a>
        <a id="navItemQR" class="nav-item nav-link navMainItem" href="#">
            <span class="fas fa-qrcode"></span>
        </a>
      </nav>

<!--change connection dialog -->
<div class="modal fade" id="mdlChangeConnection" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
			<h5 class="modal-title" id="exampleModalLabel">API Connection</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
                <form id="frmChangeConnection">
                    <div class="mb-3">
                        <label>URL : </label>
                        <input type="text" name="txtURL" class="form-control" required />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" form="frmChangeConnection" class="btn btn-primary">Save changes</button>
            </div>
		</div>
	</div>
</div>
<!-- End change connection dialog -->

<!-- report dialog -->
<div class="modal fade" id="mdlViewReport" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-sm">
		<div class="modal-content">
			<div class="modal-header">
			<h5 class="modal-title" id="exampleModalLabel">View Report</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form id="frmViewReport">
					<div class="form-group m-3">
						<div class="row">
							<div class="col-4">
								<label>Report Type:</label>
							</div>
							<div class="col-8">
								<input type="text" name="txtReportType" class="form-control" />
							</div>
						</div>
					</div>
                    <div class="form-group m-3">
						<div class="row">
                            <div class="col-4">
								<label>Status:</label>
							</div>
							<div class="col-8">
								<input type="text" name="txtReportStatus" class="form-control" />
							</div>
						</div>
					</div>
                    <div class="form-group m-3">
						<div class="row">
							<div class="col-4">
								<label>Reported By:</label>
							</div>
							<div class="col-8">
								<input type="text" name="txtReportedBy" class="form-control" />
							</div>
					</div>
                    <div class="form-group m-3">
						<div class="row">
                            <div class="col-4">
								<label>Report Date/Time:</label>
							</div>
							<div class="col-8">
								<input type="text" name="txtReportedDateTime" class="form-control" />
							</div>
						</div>
					</div>
                    <hr>
                    <div class="form-group m-3">
						<div class="row">
                            <label>Report Details: </label>
                            <textarea name="txtReportDetails" class="form-control" style="min-height:200px; font-size:13px; margin:10px 0 0 0 "></textarea>
						</div>
					</div>
                    <hr>
                    <div class="form-group m-3">
						<div class="row">
							<div class="col-4">
								<label>Acknowledged By:</label>
							</div>
							<div class="col-8">
								<input type="text" name="txtAcknowledgedBy" class="form-control" />
							</div>
						</div>
					</div>
                    <div class="form-group m-3">
						<div class="row">
                            <div class="col-4">
								<label>Acknowledgement Date/Time:</label>
							</div>
							<div class="col-8">
								<input type="text" name="txtAcknowledgedDateTime" class="form-control" />
							</div>
						</div>
					</div>
                    <div class="form-group m-3">
						<div class="row">
                            <label>Acknowledgement Remarks: </label>
                            <textarea name="txtAcknowledgedmentRemarks" class="form-control" style="min-height:200px; font-size:13px; margin:10px 0 0 0 "></textarea>
						</div>
					</div>
                    <hr>
                    <div class="form-group m-3">
						<div class="row">
							<div class="col-4">
								<label>Tagged Resolved By:</label>
							</div>
							<div class="col-8">
								<input type="text" name="txtTaggedResolvedBy" class="form-control" />
							</div>
						</div>
					</div>
                    <div class="form-group m-3">
						<div class="row">
                            <div class="col-4">
								<label>Tagged Resolved Date/Time:</label>
							</div>
							<div class="col-8">
								<input type="text" name="txtTaggedResolvedDateTime" class="form-control" />
							</div>
						</div>
					</div>
                    <div class="form-group m-3">
						<div class="row">
                            <label>Tagged Resolved Remarks: </label>
                            <textarea name="txtTaggedResolvedRemarks" class="form-control" style="min-height:200px; font-size:13px; margin:10px 0 0 0 "></textarea>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="mdlNewReport" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-sm">
		<div class="modal-content">
			<div class="modal-header">
			<h5 class="modal-title" id="exampleModalLabel">New Report</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form id="frmNewReport">
					<div class="form-group m-3">
						<div class="row">
							<div class="col-2">
								<label>Report Type:</label>
							</div>
							<div class="col-10">
								<select name="cboTypes" class="form-select">
                                </select>
							</div>
                            
						</div>
					</div>
                    <div class="form-group m-3">
						<div class="row">
                            <label>Report Details: </label>
                            <textarea name="txtReportDetails" class="form-control" style="min-height:200px; font-size:13px; margin:10px 0 0 0 "></textarea>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" form="frmNewReport" class="btn btn-primary">Save changes</button>
			</div>
		</div>
	</div>
</div>
<!-- end of report dialogs -->


<script defer="true">
    $(document).ready( function(){
        let currentNavItemID = "";
        let UserObj = {};
        /////////////////

        $("#frmNewReport").submit( function(event){
            event.preventDefault();
            let url = localStorage.getItem('APIURL') + "/API/CreateNewReport.php";
            let data = $(this).serializeArray();
            data.push({name:"ReporterID", value : UserObj.DataCenterID});
            $.post(url, data, function(res){
                if(res.result){
					alert("Report has been successfully saved.");
					$(".modal").modal('hide');
				}
				else{
					alert("Failed to save new report.");
				}
            }, 'json')
            .fail( function(xhr, status, message){
                alert("Error has occured !" +  message);
            });
        });

        $("#main").on('click', '.reportItem .btnViewReport', function(){
            $("#mdlViewReport").modal('show');
        });

        $("#main").on('click', '#btnNewReport', function(){
            $("#mdlNewReport").modal('show');
        });

        $("#main").on('submit', '#frmSearchReports', function(event){
            event.preventDefault();
            let url = localStorage.getItem('APIURL') + "/API/GetResidentReports.php";
            let data = $(this).serializeArray();
            data.push({name : "ResidentID", value : UserObj.DataCenterID});
            console.log(data);
            $.post(url, data, function(res){
                let $list = $("#reportsList");
                $list.html("");
                $("#lblReportsCount").html(res.length);
                if(res.length > 0){
                    $.each(res, function(indx, value){
                        $list.append(`
                        <div class="card mb-3 reportItem" id="`+ value.ReportID +`" >
                            <div class="card-body">
                            <h6 class="card-title">Report No : `+ value.ReportNo +`</h6>
                            <hr style="margin: 5px;">
                            <p class="card-text">
                                <label>Date Reported : <span>`+ value.CreatedDateTime +`</span></label>
                                <br/>
                                <label>Status : <span>`+ value.ReportStatus +`</span></label>
                            </p>
                            <hr style="margin: 5px;">
                            <div class="row">
                                <div class="col-6">
                                    <button class="btn btn-primary btnViewReport w-100">
                                        <span class="fas fa-eye"></span>
                                        View
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-warning btnEditReport w-100" style="display:`+(parseInt(value.isAllowUpdateStatus) > 0 ? "block" : "none")+`">
                                        <span class="fas fa-edit"></span>
                                        Edit
                                    </button>
                                </div>
                            </div>
                            </div>
                        </div>
                            `);
                    });
                }
                
            }, 'json')
            .fail( function(xhr, status, message){
                alert("Error has occured !" +  message);
            });
        }) ;

        $(".navMainItem").click( function(){
            let id = $(this).prop("id");
            if(id != currentNavItemID && id == "navItemHome"){
                currentNavItemID = id;
                loadHomepage();
            }
            else if(id != currentNavItemID && id == "navItemQR"){
                currentNavItemID = id;
                loadQRCodePage();
            }
            else if(id != currentNavItemID && id == "navItemReports"){
                currentNavItemID = id;
                loadReportsPage();
            }
            $(".navMainItem").removeClass('active');
            $(this).addClass('active');
        });

        $("#frmLogin").submit( function(event){
            event.preventDefault();
            let url = localStorage.getItem('APIURL') + "/API/Userlogin.php";
            let data = $(this).serialize();
            $.post(url, data, function(res){
                if(res != undefined){
                    UserObj = res;
                    $("#loginForm").slideUp();
                    loadHomepage();
                }
                else{
                    alert("User not found or mismatched credentials.");
                }
            }, 'json')
            .fail( function(xhr, status, message){
				msgPopUp("Error has occured", message, "danger");
			});
        });

        $("#frmChangeConnection").submit( function(event){
            event.preventDefault();
            localStorage.setItem("APIURL", $("#frmChangeConnection input[name=txtURL]").val());
            $(".modal").modal('hide');
        });
        $("#btnChangeConnection").click( function(){
            $("#frmChangeConnection input[name=txtURL]").val(localStorage.getItem("APIURL"))
            $("#mdlChangeConnection").modal('show');
        });

        
        ///////////////////////
        function loadHomepage(){
            $.get("homepage.html", function(data){
                $("#main").html(data);
                $("#mainGreetUsername").html(UserObj.FirstName);
                loadRecentAnnouncements();
                loadHouseHoldVisitors();
                loadHouseHoldVisitsForApproval();
            });
        }

        function loadQRCodePage(){
            $.get("QRCode.html", function(data){
                $("#main").html(data);
                $("#qrcode").qrcode({
						text : UserObj.QRCode,
						width : $("#qrcode").width(),
						height : $("#qrcode").width()
					});
                $("#qrcodeString").html(UserObj.QRCode)
            });
        }

        function loadReportsPage(){
            $.get("reports.html", function(data){
                $("#main").html(data);
                var date = new Date();
                var currentDate = date.toISOString().substring(0,10);
                $("#frmSearchReports input[name=txtDateStart]").val(currentDate);
                $("#frmSearchReports input[name=txtDateEnd]").val(currentDate);
                loadReportTypes();
                
            });
        }

        function loadRecentAnnouncements(){
            let url = localStorage.getItem('APIURL') + "/API/GetRecentAnnouncements.php";
            $.get(url, function(res){
                console.log(res);
                if(res.length > 0){
                    
                    let $list = $("#listRecentAnnouncements ul");
                    $list.html("");
                    $.each(res, function(indx, value){
                        $list.append(`
                        <li id="`+ value.AnnouncementID +`" class="list-group-item">
                            <div class="row">
                                <div class="col-2">
                                    <button class="btn btn-primary">
                                        <span class="fas fa-eye"></span>
                                    </button>
                                </div>
                                <div class="col-10">
                                    <label>`+ value.Title +`</label>
                                    <label>`+ value.PublishedDateTime + " | " + value.AnnouncementType +`</label>
                                </div>
                            </div>
                        </li>
                            `);
                    });
                }
                else{
                    $("#listRecentAnnouncements ul").html("No recent announcements...")
                }
            }, 'json');
        }

        function loadHouseHoldVisitors(){
            let url = localStorage.getItem('APIURL') + "/API/GetHouseHoldVisitors.php?ID=" + UserObj.HouseHoldID ;
            $.get(url, function(res){
                console.log(res);
                if(res.length > 0){
                    
                    let $list = $("#listHouseHoldVisitors ul");
                    $list.html("");
                    $.each(res, function(indx, value){
                        $list.append(`
                        <li id="`+ value.VisitorID +`" class="list-group-item">
                            `+ value.VisitorName +`
                        </li>
                            `);
                    });
                }
                else{
                    $("#listHouseHoldVisitors ul").html("No visitors...")
                }
            }, 'json');
        }

        function loadHouseHoldVisitsForApproval(){
            let url = localStorage.getItem('APIURL') + "/API/GetAllVisitsForApproval.php?ID=" + UserObj.HouseHoldID ;
            $.get(url, function(res){
                console.log(res);
                if(res.length > 0){
                    
                    let $list = $("#listHouselHoldVisitorsForApproval ul");
                    $list.html("");
                    $.each(res, function(indx, value){
                        $list.append(`
                        <li id="`+ value.VisitorID +`" class="list-group-item">
                            <div class="row">
                                <div class="col-2">
                                    <button class="btn btn-primary">
                                        <span class="fas fa-eye"></span>
                                    </button>
                                </div>
                                <div class="col-10">
                                    <label>`+ value.VisitorName +`</label>
                                </div>
                            </div>
                        </li>
                            `);
                    });
                }
                else{
                    $("#listHouselHoldVisitorsForApproval ul").html("No visitors...")
                }
            }, 'json');
        }

        function loadReportTypes(){ 
            let url = localStorage.getItem('APIURL') + "/API/GetReportTypes.php";
            let data = {txtSearch : ""};
            $.post(url, data, function(res){
                let $rptType = $("#frmSearchReports select[name=cboTypes]");
                $rptType.html("");
                $rptType.append(`<option value="0">All</option>`);
                let $rptTypeForNewReport = $("#frmNewReport select[name=cboTypes]");
                $rptTypeForNewReport.html("");
                $.each(res, function(indx, value){
                    $rptType.append(`<option value="`+ value.ReportTypeID +`">`+ value.Description +`</option>`);
                    $rptTypeForNewReport.append(`<option value="`+ value.ReportTypeID +`">`+ value.Description +`</option>`);
                });

            }, 'json');
        }

    });
</script>

</html>